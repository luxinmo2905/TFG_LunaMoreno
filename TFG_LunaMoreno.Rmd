---
title: "TFG"
author: "Luna Moreno"
date: "2025-05-27"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, include=FALSE}
library(rjags)
library(R2jags)
library(ggplot2)
library(dplyr)
library(BAS)
library(reshape2)
library(mice)
library(openxlsx)
library(coda)
library(purrr)
library(readxl)
library(runjags)
library(tidyr)
library(readr)
source("DBDA2E-utilities.R" )
```
```{r, include=FALSE}
###----Lectura de datos----

consolidated_df3 <- read.csv("data_latentes/results/consolidated_df_3.csv")

#------Imputación de datos----- 
# Realizar la imputación
imputed_data <- mice(consolidated_df3, m = 5, method = 'pmm', seed = 500)

df <- complete(imputed_data, 1)

#Nos quedamos con las entradas que estén completas
df <- consolidated_df3[complete.cases(consolidated_df3),]

#Identificamos las entradas como mutadas y no mutadas
df$Mutation2 <- factor(df$Mutation, labels = c("No mutation", "Mutation"))

#Identificamos si no hay presencia del gen apoe4, si hay un alelo, o si son los dos
df$apoe2[df$apoe==22] <- "no4"
df$apoe2[df$apoe==23] <- "no4"
df$apoe2[df$apoe==24] <- "4"
df$apoe2[df$apoe==33] <- "no4"
df$apoe2[df$apoe==34] <- "4"
df$apoe2[df$apoe==44] <- "44"
df$apoe2<- factor(df$apoe2, levels = c("no4","4","44"))
df$Mutationtype2 <- factor(df$MUTATIONTYPE*df$Mutation, labels = c("non_carriers","presenil1", "presenil2","app"))
```
## MODELO BASE 3 LATENTES

```{r, include=FALSE}
fit <- lm(mri_z_mu_1 ~ Mutationtype2 * (DIAN_EYO + gender+ cdrglob)+ apoe2 + COG_executive + COG_global, data=df, x = TRUE)

#------ para JAGS------
N <- dim(df)[1]
X <- as.matrix(cbind(model.matrix(fit))) 
ind <- as.numeric(as.factor((df$id))) 
ind
I <-length(unique(df$id))
p <- dim(X)[2]
forJags <- list(X=X,  # predictors
                x=df$mri_z_mu_0,  # DV
                y=df$mri_z_mu_1,
                z=df$mri_z_mu_2,
                ind = ind, #Identificador
                I = I, #Nº individuos 
                N=N,  # sample size
                mu.beta=rep(0,p),  # priors centered on 0
                tau.beta=diag(.0001,p)) 

#-----compilación a JAGS------
modelstring="
  model {
    for (i in 1:N) {
      x[i]~dnorm(mux[i],tau)
      mux[i] <- inprod(betax[],X[i,]) + b[ind[i]]
      y[i]~dnorm(muy[i],tau)
      muy[i] <- inprod(betay[],X[i,]) + alphay*b[ind[i]]
      z[i]~dnorm(muz[i],tau)
      muz[i] <- inprod(betaz[],X[i,]) + alphaz*b[ind[i]]
    }
    for(j in 1:I){
  b[j] ~ dnorm(0,tau.b)
  #by[j] ~ dnorm(0,tau.by)
  #bz[j] ~ dnorm(0,tau.bz)
  }
  betax ~ dmnorm(mu.beta,tau.beta)
  betay ~ dmnorm(mu.beta,tau.beta)
  betaz ~ dmnorm(mu.beta,tau.beta)
  tau  <- 1/(sig*sig)
  
  sig~ dunif(0,100)  
  
  tau.b <- 1/(sigb*sigb)
  sigb~ dunif(0,100)
  alphay~dnorm(0,0.0001)
  alphaz~dnorm(0,0.0001)
  }
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(modelstring,file=tmps)
close(tmps)
model=jags.model(tmpf,data=forJags,n.chains = 3,n.adapt = 1e5)
update(model,n.iter=100000)

output=coda.samples(model=model,variable.names=c("betax", "betaz","betay","sig","sigb","alphay","alphaz"), n.iter=100000, thin=10)

resumen <- (summary(output))
resumen

dic_output <- dic.samples(model, n.iter = 10000, thin = 10)
dic_val <- sum(dic_output$deviance) + sum(dic_output$penalty)
dic_val

# modelo_descripcion <- deparse(fit$call$formula)
# 
# dic_resultado <- data.frame(
#   Modelo = modelo_descripcion,
#   DIC = round(dic_val, 3) 
# )

#archivo <- "ResultadosLuna/resultados_modelos_DIC_3.xlsx"

# if (file.exists(archivo)) {
#   hoja_existente <- read.xlsx(archivo)
#   names(hoja_existente) <- names(dic_resultado)
#   hoja_nueva <- rbind(hoja_existente, dic_resultado)
# } else {
#   hoja_nueva <- dic_resultado
# }

#write.xlsx(hoja_nueva, file = archivo, overwrite = TRUE)
```


## MODELO MODIFICADO 3 LATENTES 

```{r}
fit <-glm(mri_z_mu_1 ~ Mutationtype2 + DIAN_EYO * apoe2 + gender + CDRSUM, data=df)

#------ para JAGS------
N <- dim(df)[1]
X <- as.matrix(cbind(model.matrix(fit))) 
ind <- as.numeric(as.factor((df$id))) 
ind
I <-length(unique(df$id))
p <- dim(X)[2]
forJags <- list(X=X,  # predictors
                x=df$mri_z_mu_0,  # DV
                y=df$mri_z_mu_1,
                z=df$mri_z_mu_2,
                ind = ind, #Identificador
                I = I, #Nº individuos 
                N=N,  # sample size
                mu.x1=rep(0,p), 
                mu.x2=rep(0,p),
                mu.x3=rep(0,p),
                tau.x1 = diag(.0001,p),
                tau.x2 = diag(.0001,p),
                tau.x3 = diag(.0001,p))

#-----compilación a JAGS------
modelstring="
  model {
    for (i in 1:N) {
      x[i]~dnorm(mux[i],taux1)
      mux[i] <- inprod(betax[],X[i,]) + bx1[ind[i]]
      y[i]~dnorm(muy[i],taux2)
      muy[i] <- inprod(betay[],X[i,]) + alphay*bx2[ind[i]]
      z[i]~dnorm(muz[i],taux3)
      muz[i] <- inprod(betaz[],X[i,]) + alphaz*bx3[ind[i]]
    }
    for(j in 1:I){
  bx1[j] ~ dnorm(0,tau.bx1)
  bx2[j] ~ dnorm(0,tau.bx2)
  bx3[j] ~ dnorm(0,tau.bx3)
  }
  betax ~ dmnorm(mu.x1,tau.x1)
  betay ~ dmnorm(mu.x2,tau.x2)
  betaz ~ dmnorm(mu.x3,tau.x3)
  
  taux1  <- 1/(sigx1*sigx1)
  taux2  <- 1/(sigx2*sigx2)
  taux3  <- 1/(sigx3*sigx3)
  
  sigx1~ dunif(0,100)  
  sigx2~ dunif(0,100)
  sigx3~ dunif(0,100)
  
  tau.bx1  <- 1/(sigbx*sigbx)
  tau.bx2  <- 1/(sigby*sigby)
  tau.bx3  <- 1/(sigbz*sigbz)
  sigbx~ dunif(0,100)
  sigby~ dunif(0,100)
  sigbz~ dunif(0,100)
  alphay~dnorm(0,0.0001)
  alphaz~dnorm(0,0.0001)
  }
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(modelstring,file=tmps)
close(tmps)
model=jags.model(tmpf,data=forJags,n.chains = 3,n.adapt = 1e5)
update(model,n.iter=100000)

output=coda.samples(model=model,variable.names=c("betax", "betaz","betay","sigbx","sigby","sigbz","alphay","alphaz"), n.iter=100000, thin=10)

dic_output <- dic.samples(model, n.iter = 10000, thin = 10)
dic_val <- sum(dic_output$deviance) + sum(dic_output$penalty)
dic_val

# Guardar en Excel
 modelo_descripcion <- deparse(fit$call$formula)

 dic_resultado <- data.frame(
   Modelo = modelo_descripcion,
   DIC = round(dic_val, 3)
 )


archivo <- "ResultadosLuna/resultados_modelos_DIC_3mod.xlsx"
 
if (file.exists(archivo)) {
   hoja_existente <- tryCatch(
     read.xlsx(archivo),
     error = function(e) NULL
   )
   if (!is.null(hoja_existente)) {
     names(hoja_existente) <- names(dic_resultado)
     hoja_nueva <- rbind(hoja_existente, dic_resultado)
   } else {
     hoja_nueva <- dic_resultado
   }
 } else {
   hoja_nueva <- dic_resultado
 }


 #write.xlsx(hoja_nueva, file = archivo, overwrite = TRUE)
```
## Gráficas mejor modelo

```{r}
colnames(X)
```

###Variable Mutationtype2presenil1

```{r}
#png("ImagenesTFG/betax2.png", width = 800, height = 600)
diagMCMC(output, "betax[2]") 
#dev.off()
#png("ImagenesTFG/betay2.png", width = 800, height = 600)
diagMCMC(output, "betay[2]") 
#dev.off()
#png("ImagenesTFG/betaz2.png", width = 800, height = 600)
diagMCMC(output, "betaz[2]") 
#dev.off()
```


### Variable Mutationtype2presenil2
```{r}
#png("ImagenesTFG/betax3.png", width = 800, height = 600)
diagMCMC(output, "betax[3]") 
#dev.off()
#png("ImagenesTFG/betay3.png", width = 800, height = 600)
diagMCMC(output, "betay[3]") 
#dev.off()
#png("ImagenesTFG/betaz3.png", width = 800, height = 600)
diagMCMC(output, "betaz[3]") 
#dev.off()
```


###Variable Mutationtype2app
```{r}
#png("ImagenesTFG/betax4.png", width = 800, height = 600)
diagMCMC(output, "betax[4]") 
#dev.off()
#png("ImagenesTFG/betay4.png", width = 800, height = 600)
diagMCMC(output, "betay[4]") 
#dev.off()
#png("ImagenesTFG/betaz4.png", width = 800, height = 600)
diagMCMC(output, "betaz[4]") 
#dev.off()
```


### Variable apoe24
```{r}
#png("ImagenesTFG/betax6.png", width = 800, height = 600)
diagMCMC(output, "betax[6]") 
#dev.off()
#png("ImagenesTFG/betay6.png", width = 800, height = 600)
diagMCMC(output, "betay[6]") 
#dev.off()
#png("ImagenesTFG/betaz6.png", width = 800, height = 600)
diagMCMC(output, "betaz[6]") 
#dev.off()
```


### Variable apoe244
```{r}
#png("ImagenesTFG/betax7.png", width = 800, height = 600)
diagMCMC(output, "betax[7]") 
#dev.off()
#png("ImagenesTFG/betay7.png", width = 800, height = 600)
diagMCMC(output, "betay[7]") 
#dev.off()
#png("ImagenesTFG/betaz7.png", width = 800, height = 600)
diagMCMC(output, "betaz[7]") 
#dev.off()
```

### DIAN_EYO:apoe24
```{r}
#png("ImagenesTFG/betax10.png", width = 800, height = 600)
diagMCMC(output, "betax[10]") 
#dev.off()
#png("ImagenesTFG/betay10.png", width = 800, height = 600)
diagMCMC(output, "betay[10]") 
#dev.off()
#png("ImagenesTFG/betaz10.png", width = 800, height = 600)
diagMCMC(output, "betaz[10]") 
#dev.off()
```
### DIAN_EYO:apoe244
```{r}
#png("ImagenesTFG/betax11.png", width = 800, height = 600)
diagMCMC(output, "betax[11]") 
#dev.off()
#png("ImagenesTFG/betay11.png", width = 800, height = 600)
diagMCMC(output, "betay[11]") 
#dev.off()
#png("ImagenesTFG/betaz11.png", width = 800, height = 600)
diagMCMC(output, "betaz[11]") 
#dev.off()
```


### Intercept
```{r}
diagMCMC(output, "betax[1]") 
diagMCMC(output, "betay[1]") 
diagMCMC(output, "betaz[1]")
```

### Variable DIAN_EYO
```{r}
diagMCMC(output, "betax[5]") 
diagMCMC(output, "betay[5]")
diagMCMC(output, "betaz[5]")
```

### Variable gender
```{r}
#png("ImagenesTFG/betax8.png", width = 800, height = 600)
diagMCMC(output, "betax[8]") 
#dev.off()
#png("ImagenesTFG/betay8.png", width = 800, height = 600)
diagMCMC(output, "betay[8]") 
#dev.off()
#png("ImagenesTFG/betaz8.png", width = 800, height = 600)
diagMCMC(output, "betaz[8]") 
#dev.off()
```
### Variable CDRSUM
```{r}
diagMCMC(output, "betax[9]")
diagMCMC(output, "betay[9]")
diagMCMC(output, "betaz[9]")
```

```{r}
diagMCMC(output, "sigbx") 
diagMCMC(output, "sigby") 
diagMCMC(output, "sigbz") 
diagMCMC(output, "alphay")
diagMCMC(output, "alphaz")

save(output, file = "latent2.rda")

```
## Gráficas evolución


```{r}
# Secuencia de EYO para predicción
EYO <- seq(-40, 25, length.out = 200)

# Función de predicción con CDRSUM añadido correctamente
latentes <- function(gender, apoe4, apoe44, app, persenil1, persenil2, EYO) {
  
  x <- unlist(output[,"betax[1]"]) + 
       unlist(output[,"betax[5]"])*EYO + 
       unlist(output[,"betax[6]"])*apoe4 + 
       unlist(output[,"betax[7]"])*apoe44 + 
       unlist(output[,"betax[9]"])*EYO*apoe4 + 
       unlist(output[,"betax[10]"])*EYO*apoe44 + 
       unlist(output[,"betax[4]"])*app + 
       unlist(output[,"betax[2]"])*persenil1 + 
       unlist(output[,"betax[3]"])*persenil2 + 
       unlist(output[,"betax[8]"])*gender + 
       unlist(output[,"betax[11]"])

  y <- unlist(output[,"betay[1]"]) + 
       unlist(output[,"betay[5]"])*EYO + 
       unlist(output[,"betay[6]"])*apoe4 + 
       unlist(output[,"betay[7]"])*apoe44 + 
       unlist(output[,"betay[9]"])*EYO*apoe4 + 
       unlist(output[,"betay[10]"])*EYO*apoe44 + 
       unlist(output[,"betay[4]"])*app + 
       unlist(output[,"betay[2]"])*persenil1 + 
       unlist(output[,"betay[3]"])*persenil2 + 
       unlist(output[,"betay[8]"])*gender + 
       unlist(output[,"betay[11]"])

  z <- unlist(output[,"betaz[1]"]) + 
       unlist(output[,"betaz[5]"])*EYO + 
       unlist(output[,"betaz[6]"])*apoe4 + 
       unlist(output[,"betaz[7]"])*apoe44 + 
       unlist(output[,"betaz[9]"])*EYO*apoe4 + 
       unlist(output[,"betaz[10]"])*EYO*apoe44 + 
       unlist(output[,"betaz[4]"])*app + 
       unlist(output[,"betaz[2]"])*persenil1 + 
       unlist(output[,"betaz[3]"])*persenil2 + 
       unlist(output[,"betaz[8]"])*gender + 
       unlist(output[,"betaz[11]"])

  lat <- data.frame(mri_mu0 = x, mri_mu1 = y, mri_mu2 = z)

  res <- c(
    apply(lat, MARGIN = 2, mean),
    apply(lat, MARGIN = 2, quantile, prob = 0.025),
    apply(lat, MARGIN = 2, quantile, prob = 0.975)
  )
  
  names(res) <- c(
    names(lat),
    paste0(names(lat), "_low"),
    paste0(names(lat), "_sup")
  )

  return(res)
}


```

```{r}
#------ No apoe4, no mutación, gender 0------

fit <- latentes(1,0,0,1,0,0,-20) #Solo para crear el banco de datos 
evol_no_no_0 <- data.frame(EYO = 0,t(fit))

gender <- 0 
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_no_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}

#------ No apoe4, no mutacion, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_no_no_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_no_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe4, no mutacion, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_no_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_no_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}



#------ apoe4, no mutacion, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_no_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_no_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, no mutacion, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_no_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_no_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, no mutacion, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_no_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_no_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ No apoe4, persenil 1, gender 0------

fit <- latentes(1,0,0,1,0,0,-20) #Solo para crear el banco de datos 
evol_no_per1_0 <- data.frame(EYO = 0,t(fit))

gender <- 0 
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_per1_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}

#------ No apoe4, persenil 1, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_no_per1_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_per1_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe4, persenil 1, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_per1_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_per1_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}



#------ apoe4, persenil 1 gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_per1_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_per1_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, persenil 1, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_per1_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_per1_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, persenil 1, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_per1_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 1
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_per1_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ No apoe4, persenil2, gender 0------

fit <- latentes(1,0,0,1,0,0,-20) #Solo para crear el banco de datos 
evol_no_per2_0 <- data.frame(EYO = 0,t(fit))

gender <- 0 
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_no_per2_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}

#------ No apoe4, persenil2, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_no_per2_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_no_per2_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe4, persenil2, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_per2_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_4_per2_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}



#------ apoe4, persenil2, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_per2_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 1
apoe44 <- 0
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_4_per2_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, persenil2, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_per2_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_44_per2_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, persenil2, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_per2_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 1
app <- 0
persenil1 <- 0
persenil2 <- 1

for(i in 1:length(EYO)){
  evol_44_per2_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}







#------ No apoe4, app, gender 0------

fit <- latentes(1,0,0,1,0,0,-20) #Solo para crear el banco de datos 
evol_no_app_0 <- data.frame(EYO = 0,t(fit))

gender <- 0 
apoe4 <- 0
apoe44 <- 0
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_app_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}

#------ No apoe4, app, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_no_app_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 0
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_no_app_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe4, app, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_app_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 1
apoe44 <- 0
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_app_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}



#------ apoe4, app, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_4_app_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 1
apoe44 <- 0
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_4_app_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, app, gender 0------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_app_0 <- data.frame(EYO = 0,t(fit))

gender <- 0
apoe4 <- 0
apoe44 <- 1
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_app_0[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i])))
}


#------ apoe44, app, gender 1------

fit <- latentes(1,0,0,1,0,0,-20)
evol_44_app_1 <- data.frame(EYO = 0,t(fit))

gender <- 1
apoe4 <- 0
apoe44 <- 1
app <- 1
persenil1 <- 0
persenil2 <- 0

for(i in 1:length(EYO)){
  evol_44_app_1[i,] <- c(EYO[i],t(latentes(gender, apoe4, apoe44, app, persenil1, persenil2,EYO[i]))) }
```

### MRI_MU0
```{r}

# Creación del gráfico
p <- ggplot() +
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_0, group = id)) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_0)) +
  labs(x = "Estimated years to onset") +
  geom_ribbon(data = evol_no_no_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "blue") +
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu0), color = "blue")+
  geom_ribbon(data = evol_no_no_1, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "pink") +
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu0), color = "pink")+
  geom_ribbon(data = evol_4_no_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "red") +
  geom_line(data = evol_4_no_0, aes(x = EYO, y = mri_mu0), color = "red")+
  geom_ribbon(data = evol_44_no_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "green") +
  geom_line(data = evol_44_no_0, aes(x = EYO, y = mri_mu0), color = "green")+  
  geom_ribbon(data = evol_44_app_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "orange") +
  geom_line(data = evol_44_app_0, aes(x = EYO, y = mri_mu0), color = "orange")+  
  geom_ribbon(data = evol_44_per2_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "yellow") +
  geom_line(data = evol_44_per2_0, aes(x = EYO, y = mri_mu0), color = "yellow") +  
  geom_ribbon(data = evol_4_per1_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "grey") +
  geom_line(data = evol_4_per1_0, aes(x = EYO, y = mri_mu0), color = "grey") +  
  geom_ribbon(data = evol_44_per1_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "grey2") +
  geom_line(data = evol_44_per1_0, aes(x = EYO, y = mri_mu0), color = "grey2") 

p

#mean(EYOx+EYO_apoe44x+EYO_persenil1x)/mean(EYOx+EYO_persenil1x)
#mean(EYOx+EYO_apoe44x+EYO_persenil2x)/mean(EYOx+EYO_persenil2x)
#mean(EYOx+EYO_apoe44x+EYO_appx)/mean(EYOx+EYO_appx)

#ggsave("ImagenesTFG/Grafico_mri_mu0.png", width = 12, height = 6, dpi = 300)
```

### MRI_MU2
```{r}
# Creación del gráfico
p <- ggplot() +
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_2, group = id)) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_2)) +
  labs(x = "Estimated years to onset") +
  geom_ribbon(data = evol_no_no_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "blue")+
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu2), color = "blue")+
  geom_ribbon(data = evol_no_no_1, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "pink") +
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu2), color = "pink")+
  geom_ribbon(data = evol_4_no_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "red") +
  geom_line(data = evol_4_no_0, aes(x = EYO, y = mri_mu2), color = "red")+
  geom_ribbon(data = evol_44_no_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "green") +
  geom_line(data = evol_44_no_0, aes(x = EYO, y = mri_mu2), color = "green")+  
  geom_ribbon(data = evol_44_app_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "orange") +
  geom_line(data = evol_44_app_0, aes(x = EYO, y = mri_mu2), color = "orange")+  
  geom_ribbon(data = evol_44_per2_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "yellow") +
  geom_line(data = evol_44_per2_0, aes(x = EYO, y = mri_mu2), color = "yellow") +  
  geom_ribbon(data = evol_4_per1_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "grey") +
  geom_line(data = evol_4_per1_0, aes(x = EYO, y = mri_mu2), color = "grey") +  
  geom_ribbon(data = evol_44_per1_0, aes(x = EYO, ymin = mri_mu2_low, ymax = mri_mu2_sup), alpha = 0.2, fill = "grey2") +
  geom_line(data = evol_44_per1_0, aes(x = EYO, y = mri_mu2), color = "grey2") 


p


# mean(EYOz+EYO_apoe44z+EYO_persenil1z)/mean(EYOz+EYO_persenil1z)
# mean(EYOz+EYO_apoe44z+EYO_persenil2z)/mean(EYOz+EYO_persenil2z)
# mean(EYOz+EYO_apoe44z+EYO_appz)/mean(EYOz+EYO_appz)

#ggsave("ImagenesTFG/Grafico_mri_mu2.png", width = 12, height = 6, dpi = 300)
```
### MRI_MU1

```{r}
# Creación del gráfico
p <- ggplot() +
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1, group = id)) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1)) +
  labs(x = "Estimated years to onset") +
  geom_ribbon(data = evol_no_no_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "blue")+
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu1), color = "blue")+
  geom_ribbon(data = evol_no_no_1, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "pink") +
  geom_line(data = evol_no_no_0, aes(x = EYO, y = mri_mu1), color = "pink")+
  geom_ribbon(data = evol_4_no_0, aes(x = EYO, ymin = mri_mu1_low, ymax =mri_mu1_sup), alpha = 0.2, fill = "red") +
  geom_line(data = evol_4_no_0, aes(x = EYO, y = mri_mu1), color = "red")+
  geom_ribbon(data = evol_44_no_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "green") +
  geom_line(data = evol_44_no_0, aes(x = EYO, y = mri_mu1), color = "green")+  
  geom_ribbon(data = evol_44_app_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "orange") +
  geom_line(data = evol_44_app_0, aes(x = EYO, y = mri_mu1), color = "orange")+  
  geom_ribbon(data = evol_44_per2_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "yellow") +
  geom_line(data = evol_44_per2_0, aes(x = EYO, y = mri_mu1), color = "yellow") +  
  geom_ribbon(data = evol_4_per1_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "grey") +
  geom_line(data = evol_4_per1_0, aes(x = EYO, y = mri_mu1), color = "grey") +  
  geom_ribbon(data = evol_44_per1_0, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup), alpha = 0.2, fill = "grey2") +
  geom_line(data = evol_44_per1_0, aes(x = EYO, y = mri_mu1), color = "grey2") 


p


# mean(EYOy+EYO_apoe44y+EYO_persenil1y)/mean(EYOy+EYO_persenil1y)
# mean(EYOy+EYO_apoe44y+EYO_persenil2y)/mean(EYOy+EYO_persenil2y)
# mean(EYOy+EYO_apoe44y+EYO_appy)/mean(EYOy+EYO_appy)

#ggsave("ImagenesTFG/Grafico_mri_mu1.png", width = 12, height = 6, dpi = 300)
```


```{r}
p <- ggplot() +
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_0, group = id)) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_0)) +
  labs(x = "Estimated years to onset") +
  geom_ribbon(data = evol_no_per1_0, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "blue") +
  geom_line(data = evol_no_per1_0, aes(x = EYO, y = mri_mu0), color = "blue")+
  geom_ribbon(data = evol_44_per1_1, aes(x = EYO, ymin = mri_mu0_low, ymax = mri_mu0_sup), alpha = 0.2, fill = "pink") +
  geom_line(data = evol_44_per1_0, aes(x = EYO, y = mri_mu0), color = "pink")
# Mostrar el gráfico
print(p)

#ggsave("ImagenesTFG/Grafico_mri_mu1.png", width = 12, height = 6, dpi = 300)
```


```{r}
evol_all <- rbind(
  cbind(evol_no_no_1, group = "Non-carriers"),
  cbind(evol_4_no_1, group = "Heterozygous APOE4"),
  cbind(evol_44_no_1, group = "Homozygous APOE4")
)

# Asegura el orden deseado en la leyenda
evol_all$group <- factor(evol_all$group, levels = c("Non-carriers", "Heterozygous APOE4", "Homozygous APOE4"))


colores_apoe <- c(
  "Non-carriers"        = "#377eb8",  # Azul
  "Heterozygous APOE4"  = "#4daf4a",  # Verde
  "Homozygous APOE4"    = "#e41a1c"   # Rojo
)

p <- ggplot() +
  # Trayectorias individuales
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1, group = id), alpha = 0.4) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1), alpha = 0.4) +
  
  # Bandas de credibilidad y líneas de predicción
  geom_ribbon(data = evol_all, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup, fill = group), alpha = 0.2) +
  geom_line(data = evol_all, aes(x = EYO, y = mri_mu1, color = group), size = 1) +

  # Etiquetas
  labs(
    x = "Estimated years to onset",
    y = "MRI latent dimension (μ₁)",
    color = "APOE4 status",
    fill = "APOE4 status"
  ) +
  
  scale_color_manual(values = colores_apoe) +
  scale_fill_manual(values = colores_apoe) +
  theme_minimal()

# Mostrar el gráfico
print(p)


#ggsave("ImagenesTFG/Grafico_efectoapoe4aislado_h.png", width = 12, height = 6, dpi = 300)
```
```{r}
evol_all <- rbind(
  cbind(evol_no_no_0, group = "Non-carriers"),
  cbind(evol_4_no_0, group = "Heterozygous APOE4"),
  cbind(evol_44_no_0, group = "Homozygous APOE4")
)

# Asegura el orden deseado en la leyenda
evol_all$group <- factor(evol_all$group, levels = c("Non-carriers", "Heterozygous APOE4", "Homozygous APOE4"))


colores_apoe <- c(
  "Non-carriers"        = "#377eb8",  # Azul
  "Heterozygous APOE4"  = "#4daf4a",  # Verde
  "Homozygous APOE4"    = "#e41a1c"   # Rojo
)

p <- ggplot() +
  # Trayectorias individuales
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1, group = id), alpha = 0.4) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1), alpha = 0.4) +
  
  # Bandas de credibilidad y líneas de predicción
  geom_ribbon(data = evol_all, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup, fill = group), alpha = 0.2) +
  geom_line(data = evol_all, aes(x = EYO, y = mri_mu1, color = group), size = 1) +

  # Etiquetas
  labs(
    x = "Estimated years to onset",
    y = "MRI latent dimension",
    color = "APOE4 status",
    fill = "APOE4 status"
  ) +
  
  scale_color_manual(values = colores_apoe) +
  scale_fill_manual(values = colores_apoe) +
  theme_minimal()

# Mostrar el gráfico
print(p)



#ggsave("ImagenesTFG/Grafico_efectoapoe4aislado_m.png", width = 12, height = 6, dpi = 300)
```

```{r}
evol_all <- rbind(
  cbind(evol_no_app_0, group = "APP"),
  cbind(evol_no_per1_0, group = "PSEN1"),
  cbind(evol_no_per2_0, group = "PSEN2"),
  cbind(evol_no_no_0, group = "No mutation")
)

# Convertir a factor con el orden que deseas en la leyenda
evol_all$group <- factor(evol_all$group, levels = c("No mutation", "APP", "PSEN1", "PSEN2"))


colores <- c(
  "No mutation" = "#377eb8",  # Azul
  "APP"         = "#e41a1c",  # Rojo
  "PSEN1"       = "#4daf4a",  # Verde
  "PSEN2"       = "#984ea3"   # Morado
)


p <- ggplot() +
  # Trayectorias individuales
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1, group = id), alpha = 0.3) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1), alpha = 0.3) +
  
  # Bandas y líneas medias con leyenda
  geom_ribbon(data = evol_all, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup, fill = group), alpha = 0.18) +
  geom_line(data = evol_all, aes(x = EYO, y = mri_mu1, color = group), size = 1) +

  # Etiquetas
  labs(
    x = "Estimated years to onset",
    y = "MRI latent dimension",
    color = "Mutation group",
    fill  = "Mutation group"
  ) +
  
  scale_color_manual(values = colores) +
  scale_fill_manual(values = colores) +
  theme_minimal()

print(p)


# Guardar si es necesario
# ggsave("ImagenesTFG/Grafico_efectofam_m.png", width = 12, height = 6, dpi = 300)

```
```{r}
evol_all <- rbind(
  cbind(evol_no_app_1, group = "APP"),
  cbind(evol_no_per1_1, group = "PSEN1"),
  cbind(evol_no_per2_1, group = "PSEN2"),
  cbind(evol_no_no_1, group = "No mutation")
)

# Convertir a factor con el orden que deseas en la leyenda
evol_all$group <- factor(evol_all$group, levels = c("No mutation", "APP", "PSEN1", "PSEN2"))


colores <- c(
  "No mutation" = "#377eb8",  # Azul
  "APP"         = "#e41a1c",  # Rojo
  "PSEN1"       = "#4daf4a",  # Verde
  "PSEN2"       = "#984ea3"   # Morado
)


p <- ggplot() +
  # Trayectorias individuales
  geom_line(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1, group = id), alpha = 0.3) +
  geom_point(data = df, aes(x = DIAN_EYO, y = mri_z_mu_1), alpha = 0.3) +
  
  # Bandas y líneas medias con leyenda
  geom_ribbon(data = evol_all, aes(x = EYO, ymin = mri_mu1_low, ymax = mri_mu1_sup, fill = group), alpha = 0.18) +
  geom_line(data = evol_all, aes(x = EYO, y = mri_mu1, color = group), size = 1) +

  # Etiquetas
  labs(
    x = "Estimated years to onset",
    y = "MRI latent dimension (μ₁)",
    color = "Mutation group",
    fill  = "Mutation group"
  ) +
  
  scale_color_manual(values = colores) +
  scale_fill_manual(values = colores) +
  theme_minimal()

print(p)


# Guardar si es necesario
# ggsave("ImagenesTFG/Grafico_efectofam_h.png", width = 12, height = 6, dpi = 300)
```



# VALIDACIÓN CRUZADA MODELO BASE 3 LAT

```{r}
set.seed(123)

# Preparar folds por id
subject_ids <- unique(df$id)
K <- 5
folds <- cut(seq_along(subject_ids), breaks = K, labels = FALSE)
shuffled_ids <- sample(subject_ids)
fold_assignments <- split(shuffled_ids, folds)

cv_results <- list()

for (k in 1:K) {
  cat("Fold", k, "\n")
  
  test_ids <- fold_assignments[[k]]
  train_df <- df %>% filter(!id %in% test_ids)
  test_df  <- df %>% filter(id %in% test_ids)
  
  fit_train <- glm(mri_z_mu_1 ~ Mutationtype2 * (DIAN_EYO + gender) + cdrglob + COG_executive + COG_global + apoe2, data = train_df, x = TRUE)
  
  X_train <- as.matrix(model.matrix(fit_train))
  X_test <- model.matrix(formula(fit_train), data = test_df)

  
  N_train <- nrow(train_df)
  I_train <- length(unique(train_df$id))
  ind_train <- as.numeric(as.factor(train_df$id))
  
  jags_data <- list(
    X = X_train,
    x = train_df$mri_z_mu_0,
    y = train_df$mri_z_mu_1,
    z = train_df$mri_z_mu_2,
    ind = ind_train,
    I = I_train,
    N = N_train,
    mu.beta = rep(0, ncol(X_train)),
    tau.beta = diag(0.0001, ncol(X_train))
  )
  
  modelstring="
  model {
    for (i in 1:N) {
      x[i]~dnorm(mux[i],tau)
      mux[i] <- inprod(betax[],X[i,]) + b[ind[i]]
      y[i]~dnorm(muy[i],tau)
      muy[i] <- inprod(betay[],X[i,]) + alphay*b[ind[i]]
      z[i]~dnorm(muz[i],tau)
      muz[i] <- inprod(betaz[],X[i,]) + alphaz*b[ind[i]]
    }
    for(j in 1:I){
  b[j] ~ dnorm(0,tau.b)
  #by[j] ~ dnorm(0,tau.by)
  #bz[j] ~ dnorm(0,tau.bz)
  }
  betax ~ dmnorm(mu.beta,tau.beta)
  betay ~ dmnorm(mu.beta,tau.beta)
  betaz ~ dmnorm(mu.beta,tau.beta)
  tau  <- 1/(sig*sig)
  
  sig~ dunif(0,100)  
  
  tau.b <- 1/(sigb*sigb)
  sigb~ dunif(0,100)
  alphay~dnorm(0,0.0001)
  alphaz~dnorm(0,0.0001)
  }
"
  
  jags_fit <- run.jags(model = modelstring,
                       data = jags_data,
                       monitor = c("betax", "betay", "betaz"),
                       n.chains = 3, burnin = 1000, sample = 2000, adapt = 1000,
                       summarise = FALSE, method = "rjags")
  
  samples <- as.matrix(as.mcmc(jags_fit))
  betax_mean <- colMeans(samples[, grepl("betax", colnames(samples))])
  
  mux_test <- X_test %*% betax_mean
  mse <- mean((test_df$mri_z_mu_0 - mux_test)^2)

  cv_results[[k]] <- list(mse = mse)
}

# Calcular promedio de MSE en CV
mse_vals <- map_dbl(cv_results, "mse")
cat("MSE en validación cruzada (promedio):", mean(mse_vals), "\n")

# Entrenar en todo el dataset y calcular mse_all
fit_all <- lm(mri_z_mu_1 ~ Mutationtype2 * (DIAN_EYO + gender) + cdrglob + COG_executive + COG_global + apoe2, data = df, x = TRUE)
X_all <- model.matrix(fit_all)
N_all <- nrow(df)
I_all <- length(unique(df$id))
ind_all <- as.numeric(as.factor(df$id))

jags_data_all <- list(
  X = X_all,
  x = df$mri_z_mu_0,
  y = df$mri_z_mu_1,
  z = df$mri_z_mu_2,
  ind = ind_all,
  I = I_all,
  N = N_all,
  mu.beta = rep(0, ncol(X_all)),
  tau.beta = diag(0.0001, ncol(X_all))
)

jags_fit_all <- run.jags(model = modelstring,
                         data = jags_data_all,
                         monitor = c("betax"),
                         n.chains = 3, burnin = 1000, sample = 2000, adapt = 1000,
                         summarise = FALSE, method = "rjags")

samples_all <- as.matrix(as.mcmc(jags_fit_all))
betax_mean_all <- colMeans(samples_all[, grepl("betax", colnames(samples_all))])
mux_all <- X_all %*% betax_mean_all
mse_all <- mean((df$mri_z_mu_0 - mux_all)^2)

cat("MSE en todo el conjunto (entrenamiento):", mse_all, "\n")
```
# VALIDACIÓN CRUZADA MODELO MODIFICADO 3 LATENTES
```{r}
set.seed(123)

# Preparar folds por id
subject_ids <- unique(df$id)
K <- 5
folds <- cut(seq_along(subject_ids), breaks = K, labels = FALSE)
shuffled_ids <- sample(subject_ids)
fold_assignments <- split(shuffled_ids, folds)

cv_results <- list()

for (k in 1:K) {
  cat("Fold", k, "\n")
  
  test_ids <- fold_assignments[[k]]
  train_df <- df %>% filter(!id %in% test_ids)
  test_df  <- df %>% filter(id %in% test_ids)
  
  fit_train <- glm(mri_z_mu_1 ~ Mutationtype2 + DIAN_EYO * apoe2 + gender + CDRSUM, data = train_df, x = TRUE)
  
  X_train <- as.matrix(model.matrix(fit_train))
  X_test <- model.matrix(formula(fit_train), data = test_df)

  
  N_train <- nrow(train_df)
  I_train <- length(unique(train_df$id))
  ind_train <- as.numeric(as.factor(train_df$id))
  
  jags_data <- list(
  X = X_train,
  x = train_df$mri_z_mu_0,
  y = train_df$mri_z_mu_1,
  z = train_df$mri_z_mu_2,
  ind = ind_train,
  I = I_train,
  N = N_train,
  mu.x1 = rep(0, ncol(X_train)),
  mu.x2 = rep(0, ncol(X_train)),
  mu.x3 = rep(0, ncol(X_train)),
  tau.x1 = diag(0.0001, ncol(X_train)),
  tau.x2 = diag(0.0001, ncol(X_train)),
  tau.x3 = diag(0.0001, ncol(X_train))
)

 modelstring="
  model {
    for (i in 1:N) {
      x[i]~dnorm(mux[i],taux1)
      mux[i] <- inprod(betax[],X[i,]) + bx1[ind[i]]
      y[i]~dnorm(muy[i],taux2)
      muy[i] <- inprod(betay[],X[i,]) + alphay*bx2[ind[i]]
      z[i]~dnorm(muz[i],taux3)
      muz[i] <- inprod(betaz[],X[i,]) + alphaz*bx3[ind[i]]
    }
    for(j in 1:I){
  bx1[j] ~ dnorm(0,tau.bx1)
  bx2[j] ~ dnorm(0,tau.bx2)
  bx3[j] ~ dnorm(0,tau.bx3)
  }
  betax ~ dmnorm(mu.x1,tau.x1)
  betay ~ dmnorm(mu.x2,tau.x2)
  betaz ~ dmnorm(mu.x3,tau.x3)
  
  taux1  <- 1/(sigx1*sigx1)
  taux2  <- 1/(sigx2*sigx2)
  taux3  <- 1/(sigx3*sigx3)
  
  sigx1~ dunif(0,100)  
  sigx2~ dunif(0,100)
  sigx3~ dunif(0,100)
  
  tau.bx1  <- 1/(sigbx*sigbx)
  tau.bx2  <- 1/(sigby*sigby)
  tau.bx3  <- 1/(sigbz*sigbz)
  sigbx~ dunif(0,100)
  sigby~ dunif(0,100)
  sigbz~ dunif(0,100)
  alphay~dnorm(0,0.0001)
  alphaz~dnorm(0,0.0001)
  }
"
  
  jags_fit <- run.jags(model = modelstring,
                       data = jags_data,
                       monitor = c("betax", "betay", "betaz"),
                       n.chains = 3, burnin = 1000, sample = 2000, adapt = 1000,
                       summarise = FALSE, method = "rjags")
  
  samples <- as.matrix(as.mcmc(jags_fit))
  betax_mean <- colMeans(samples[, grepl("betax", colnames(samples))])
  
  mux_test <- X_test %*% betax_mean
  mse <- mean((test_df$mri_z_mu_0 - mux_test)^2)

  cv_results[[k]] <- list(mse = mse)
}

# Calcular promedio de MSE en CV
mse_vals <- map_dbl(cv_results, "mse")
cat("MSE en validación cruzada (promedio):", mean(mse_vals), "\n")

# Entrenar en todo el dataset y calcular mse_all
fit_all <- glm(mri_z_mu_1 ~ Mutationtype2 + DIAN_EYO * apoe2 + gender + CDRSUM, data = df, x = TRUE)
X_all <- model.matrix(fit_all)
N_all <- nrow(df)
I_all <- length(unique(df$id))
ind_all <- as.numeric(as.factor(df$id))

jags_data_all <- list(
  X = X_all,
  x = df$mri_z_mu_0,
  y = df$mri_z_mu_1,
  z = df$mri_z_mu_2,
  ind = ind_all,
  I = I_all,
  N = N_all,
  mu.x1 = rep(0, ncol(X_all)),
  mu.x2 = rep(0, ncol(X_all)),
  mu.x3 = rep(0, ncol(X_all)),
  tau.x1 = diag(0.0001, ncol(X_all)),
  tau.x2 = diag(0.0001, ncol(X_all)),
  tau.x3 = diag(0.0001, ncol(X_all))
)

jags_fit_all <- run.jags(model = modelstring,
                         data = jags_data_all,
                         monitor = c("betax"),
                         n.chains = 3, burnin = 1000, sample = 2000, adapt = 1000,
                         summarise = FALSE, method = "rjags")

samples_all <- as.matrix(as.mcmc(jags_fit_all))
betax_mean_all <- colMeans(samples_all[, grepl("betax", colnames(samples_all))])
mux_all <- X_all %*% betax_mean_all
mse_all <- mean((df$mri_z_mu_0 - mux_all)^2)

cat("MSE en todo el conjunto (entrenamiento):", mse_all, "\n")

# Convertir los resultados a data.frame
mse_frame <- data.frame(
  Fold = paste0("Fold_", 1:K),
  MSE = mse_vals
)
# Añadir el promedio
mse_frame <- rbind(mse_frame, data.frame(Fold = "Average", MSE = mean(mse_vals)))

# Guardar en Excel
write.xlsx(mse_frame, file = "ResultadosLuna/resultados_validacion_cruzada.xlsx", overwrite = TRUE)
```
MSE en validación cruzada (promedio): 1.962167 
MSE en todo el conjunto (entrenamiento): 1.597864 

# LEAVE ONE INDIVIDUAL OUT MODELO MODIFICADO 3 LATENTES
```{r}
# Inicialización
loio_results <- list()
subject_ids <- unique(df$id)

for (i in seq_along(subject_ids)) {
  cat("LOO para id:", subject_ids[i], "\n")
  
  # Separar sujeto test y entrenamiento
  test_id <- subject_ids[i]
  train_df <- df %>% filter(id != test_id)
  test_df  <- df %>% filter(id == test_id)
  
  # Ajustar modelo GLM para obtener X
  fit_train <- glm(mri_z_mu_1 ~ Mutationtype2 + DIAN_EYO + apoe2 + gender + CDRSUM, 
                   data = train_df, x = TRUE)
  
  X_train <- model.matrix(fit_train)
  X_test  <- model.matrix(formula(fit_train), data = test_df)
  
  # Datos para JAGS
  N_train <- nrow(train_df)
  I_train <- length(unique(train_df$id))
  ind_train <- as.numeric(as.factor(train_df$id))
  p <- ncol(X_train)

  jags_data <- list(
    X = X_train,
    x = train_df$mri_z_mu_0,
    y = train_df$mri_z_mu_1,
    z = train_df$mri_z_mu_2,
    ind = ind_train,
    I = I_train,
    N = N_train,
    mu.x1 = rep(0, p),
    mu.x2 = rep(0, p),
    mu.x3 = rep(0, p),
    tau.x1 = diag(0.0001, p),
    tau.x2 = diag(0.0001, p),
    tau.x3 = diag(0.0001, p)
  )

  # Ajuste con run.jags
  jags_fit <- run.jags(model = modelstring,
                       data = jags_data,
                       monitor = c("betax"),
                       n.chains = 3, burnin = 1000, sample = 2000, adapt = 1000,
                       summarise = FALSE, method = "rjags")

  samples <- as.matrix(as.mcmc(jags_fit))
  betax_mean <- colMeans(samples[, grepl("betax", colnames(samples))])
  
  # Predicción y MSE
  mux_test <- X_test %*% betax_mean
  mse <- mean((test_df$mri_z_mu_0 - mux_test)^2)
  
  # Guardar resultado individual
  loio_results[[i]] <- list(id = test_id, mse = mse)
}

# Resultado agregado
mse_loio <- purrr::map_dbl(loio_results, "mse")
cat("MSE Leave-One-Individual-Out (promedio):", mean(mse_loio), "\n")

# Crear dataframe de resultados
mse_df <- tibble(
  id = subject_ids,
  mse = mse_loio
)

# Visualizar distribución del MSE
ggplot(mse_df, aes(x = mse)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black") +
  labs(title = "Distribución del MSE por sujeto (LOIO)",
       x = "MSE", y = "Frecuencia") +
  theme_minimal()

# Sujetos con mayor error
top_mse <- mse_df %>% arrange(desc(mse)) %>% head(5)
print(top_mse)

# Guardar resultados
# Instala si no tienes: install.packages("openxlsx")
library(openxlsx)

# Guardar resultados LOIO en Excel
write.xlsx(mse_df, file = "ResultadosLuna/loio_mse_results.xlsx", overwrite = TRUE)

```

MSE Leave-One-Individual-Out (promedio): 1.725015 


#DESCRIPCIÓN VARIABLES

```{r}
summary(df)

table(df$visit)
table(df$gender)
table(df$apoe2)
table(df$Mutation2)
table(df$Mutationtype2)
```

## GRÁFICO K FOLD

```{r}
cv <- read_excel("ResultadosLuna/resultados_validacion_cruzada.xlsx")

cv_folds <- cv[cv$Fold != "Average", ]

ggplot(cv_folds, aes(x = Fold, y = MSE)) +
  geom_bar(stat = "identity", fill = "#56B4E9") +  # Azul claro seguro para daltónicos
  geom_hline(yintercept = cv$MSE[cv$Fold == "Average"], 
             linetype = "dashed", 
             color = "#FF34B3",   # Fucsia brillante como en el gráfico anterior
             size = 1.2) +        # Línea más gruesa
  annotate("text",
           x = length(unique(cv_folds$Fold)) / 2, 
           y = cv$MSE[cv$Fold == "Average"],
           label = paste("Average MSE =", round(cv$MSE[cv$Fold == "Average"], 2)),
           color = "#FF34B3",
           size = 5,
           fontface = "bold",
           vjust = -0.5) +
  labs(x = "Fold",
       y = "MSE") +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.ticks.x = element_blank()
  )

ggsave("ImagenesTFG/Grafico_cv.png", width = 12, height = 6, dpi = 300)

```
## GRÁFICO LOIO
```{r}
loio <- read_excel("ResultadosLuna/loio_mse_results.xlsx")

loio_plot <- loio %>%
  mutate(id = factor(id, levels = id))

ggplot(loio_plot, aes(x = id, y = mse)) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  labs(x = "Id", y = "MSE") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),    # Oculta los textos del eje x
    axis.ticks.x = element_blank(),    # Oculta las marcas del eje x
     panel.grid.major.x = element_blank(),  # Quita la rejilla vertical principal
    panel.grid.minor.x = element_blank()  
  )+ geom_hline(yintercept = mean(loio_plot$mse), color = "#FF34B3", linetype = "dashed", size = 1.2) +
  annotate("text", 
           x = nrow(loio_plot) / 2, 
           y = mean(loio_plot$mse), 
           label = paste("Average MSE =", round(mean(loio_plot$mse), 2)),
           color = "#FF34B3", 
           size = 5,
           fontface = "bold",
           vjust = -0.5)

ggsave("ImagenesTFG/Grafico_loio.png", width = 12, height = 6, dpi = 300)

```


```{r}
library(dplyr)
df %>% filter(id == "2S2O28")
df %>% filter(id == "FU9F55")
df %>% filter(id == "M9VYFZ")

```


